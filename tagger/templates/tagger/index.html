<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NER Tagger</title>
    <style>
        body {
            margin: 0px;
            padding: 0px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #navbar {
            color: white;
            background-color: rgb(73, 131, 255);
            padding-top: 10px;
            padding-bottom: 5px;
            text-align: center;
        }
        #input-box {
            margin: 20px;
            padding: 10px;
            width: 90%;
            border-radius: 5px;
            border: 1px solid black;
            min-height: 100px;
        }
        #input button, #entity-tags button, #output button {
            margin-top: 20px;
            margin-left: 20px;
            height: 30px;
            border: 1px solid black;
            border-radius: 5px;
        }
        #input button:hover, #entity-tags button:hover, #output button:hover {
            cursor: pointer;
            background-color: rgb(73, 131, 255);
            color: white;
        }
        .highlight {
            border: 2px solid rgb(73, 131, 255);
            border-radius: 2px;
        }
        .tagged {
            border: 2px solid green;
            border-radius: 2px;
            background-color: lightgreen;
        }
        .tag-display {
            font-weight: bold;
            color: blue;
        }
        #outputbox {
            width: 90%;
            margin: 20px;
            padding: 10px;
            border: 1px solid black;
            border-radius: 5px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div id="navbar">
        <h1>NER Tagger</h1>
    </div>
    <div id="input">
        <div id="input-box" contenteditable="true" placeholder="Enter your text here"></div>
        <br>
        <button id="tag-ner-btn">Tag NER</button>
    </div>
    <div id="entity-tags">
        <button data-tag="PER">PER</button>
        <button data-tag="ORG">ORG</button>
        <button data-tag="GPE">GPE</button>
        <button data-tag="GEO">GEO</button>
        <button data-tag="ART">ART</button>
        <button data-tag="NAT">NAT</button>
        <button data-tag="EVE">EVE</button>
        <button data-tag="TIM">TIM</button>
        <button id="undo-btn">Undo</button>
    </div>
    <div id="output">
        <h4 style="margin-left: 20px;">Tagged Words</h4>
        <div id="outputbox"></div>
        <br>
        <button id="save-btn">Save</button>
    </div>

    <script>
        let selectedWord = null;
        let selectedTag = null;
        let lastAction = null;
        const taggedWords = [];

        document.getElementById('tag-ner-btn').addEventListener('click', function () {
            const text = document.getElementById('input-box').innerText.trim();
            const words = text.split(' ');
            const inputBox = document.getElementById('input-box');
            inputBox.innerHTML = '';  // Clear the input box

            // Make an AJAX request to fetch existing tags from the database
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/fetch-existing-tags/', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); // Add CSRF token for security

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const existingTags = JSON.parse(xhr.responseText);
                    words.forEach(word => {
                        const span = document.createElement('span');
                        span.textContent = word + ' ';
                        span.classList.add('word');
                        span.style.cursor = 'pointer';

                        // Check if the word exists in the database and has a tag
                        const tag = existingTags[word];
                        if (tag) {
                            span.classList.add('tagged');
                            span.setAttribute('data-tag', tag);
                            addTaggedWordToOutput(`<${tag}>${word}</${tag}>`, word, tag);
                        }

                        // Add click listener for manual selection
                        span.addEventListener('click', function () {
                            if (selectedWord) {
                                selectedWord.classList.remove('highlight');
                            }
                            span.classList.add('highlight');
                            selectedWord = span;
                        });

                        inputBox.appendChild(span);
                    });
                } else {
                    console.error('Failed to fetch existing tags');
                }
            };

            xhr.send(JSON.stringify({ words }));
        });
        
        document.querySelectorAll('#entity-tags button[data-tag]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!selectedWord) return alert('Please select a word');
                selectedTag = btn.getAttribute('data-tag');
                tagSelectedWord();
            });
        });

        function addTaggedWordToOutput(taggedWord, word, tag) {
            const outputBox = document.getElementById('outputbox');
            const span = document.createElement('span');
            span.innerHTML = `${word} <span class="tag-display">[${tag}]</span>`;
            span.classList.add('tagged-word');
            outputBox.appendChild(span);
            outputBox.appendChild(document.createTextNode(' ')); // Add space between words
        }

        function tagSelectedWord() {
            if (!selectedTag) return;
            const word = selectedWord.textContent.trim();
            selectedWord.classList.add('tagged');
            selectedWord.classList.remove('highlight');
            selectedWord.setAttribute('data-tag', selectedTag);
            const taggedWord = `<${selectedTag}>${word}</${selectedTag}>`;
            addTaggedWordToOutput(taggedWord, word, selectedTag);

            // Update or add the word and tag in the taggedWords array
            const existingIndex = taggedWords.findIndex(item => item.word === word);
            if (existingIndex !== -1) {
                taggedWords[existingIndex].tag = selectedTag;
            } else {
                taggedWords.push({ word, tag: selectedTag });
            }

            lastAction = { word, tag: selectedTag, element: selectedWord };
            updateLocalStorage();
            selectedWord = null; 
        }

        function submitTaggedWords() {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', window.location.href, true);  // POST to the current URL
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); // Add CSRF token for security

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Tagged words saved successfully');
                    alert('Tagged words have been saved to the database!');
                } else {
                    console.error('Failed to save tagged words');
                    alert('Failed to save tagged words.');
                }
            };

            // Send the tagged words as JSON
            xhr.send(JSON.stringify({ tagged_words: taggedWords }));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Undo the last action
        document.getElementById('undo-btn').addEventListener('click', function () {
            if (lastAction) {
                const { word, tag, element } = lastAction;
                element.classList.remove('tagged');
                element.removeAttribute('data-tag');
                
                // Remove the word from the output box
                const outputBox = document.getElementById('outputbox');
                const regex = new RegExp(`${word} <span class="tag-display">\\[${tag}\\]<\\/span>\\s*`, 'g');
                outputBox.innerHTML = outputBox.innerHTML.replace(regex, '');
                
                // Remove from taggedWords array
                const index = taggedWords.findIndex(item => item.word === word && item.tag === tag);
                if (index !== -1) {
                    taggedWords.splice(index, 1);
                }

                lastAction = null; // Reset lastAction after undo
                updateLocalStorage(); // Update localStorage after undo
            }
        });

        document.getElementById('save-btn').addEventListener('click', function () {
            submitTaggedWords();  // Save the tagged words to the database
            const outputBox = document.getElementById('outputbox');
            outputBox.innerHTML = null;
            const inputBox = document.getElementById('input-box');
            inputBox.innerHTML = null;
        });

        // Update localStorage
        function updateLocalStorage() {
            localStorage.setItem('taggedWords', JSON.stringify(taggedWords));
        }
    </script>
</body>
</html>
